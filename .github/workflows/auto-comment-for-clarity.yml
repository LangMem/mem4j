# Copyright 2024-2026 the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Auto Comment for Clarity
on:
  issues:
    types: [opened]
  discussion:
    types: [created]
env:
  ANTHROPIC_BASE_URL: "https://open.bigmodel.cn/api/anthropic"
jobs:
  auto-comment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      discussions: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create clarity prompt
        run: |
          mkdir -p /tmp/claude-prompts
          cat > /tmp/claude-prompts/clarity-prompt.txt << 'EOF'
          ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾åŒºåŠ©æ‰‹ã€‚è¯·åˆ†æžä»¥ä¸‹ GitHub issue/discussion çš„å†…å®¹è´¨é‡ã€‚

          ä»»åŠ¡ï¼š
          1. ä½¿ç”¨ mcp__github__get_issue èŽ·å–å†…å®¹è¯¦æƒ…
          2. åˆ†æžå†…å®¹æ˜¯å¦åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ï¼š
             - é—®é¢˜æè¿°æ˜¯å¦æ¸…æ¥š
             - æ˜¯å¦åŒ…å«é‡çŽ°æ­¥éª¤ï¼ˆå¦‚æžœæ˜¯ bugï¼‰
             - æ˜¯å¦åŒ…å«æœŸæœ›è¡Œä¸º
             - æ˜¯å¦åŒ…å«çŽ¯å¢ƒä¿¡æ¯
          3. å¦‚æžœä¿¡æ¯ä¸è¶³ï¼Œä½¿ç”¨ mcp__github__create_comment æ·»åŠ å‹å¥½çš„è¯„è®ºï¼Œè¦æ±‚è¡¥å……ä¿¡æ¯

          è¯„è®ºæ¨¡æ¿ï¼š
          æ„Ÿè°¢æ‚¨æäº¤è¿™ä¸ª issue/discussionï¼ä¸ºäº†æ›´å¥½åœ°å¸®åŠ©æ‚¨ï¼Œè¯·è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š
          - [ ] è¯¦ç»†çš„é—®é¢˜æè¿°
          - [ ] é‡çŽ°æ­¥éª¤ï¼ˆå¦‚é€‚ç”¨ï¼‰
          - [ ] æœŸæœ›çš„è¡Œä¸º
          - [ ] å®žé™…çš„è¡Œä¸º
          - [ ] çŽ¯å¢ƒä¿¡æ¯ï¼ˆç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿç­‰ï¼‰

          è¯·ç¼–è¾‘æ‚¨çš„åŽŸå§‹ issue/discussion æ¥æ·»åŠ è¿™äº›ä¿¡æ¯ã€‚
          EOF

      - name: Run Claude Code for Auto Comment
        id: claude_analysis
        uses: anthropics/claude-code-action@v1
        with:
          prompt: $(cat /tmp/claude-prompts/clarity-prompt.txt)
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools mcp__github__get_issue,mcp__github__create_comment
            --system-prompt "ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„å¼€æºé¡¹ç›®ç»´æŠ¤è€…ï¼Œæ“…é•¿è¯†åˆ«é«˜è´¨é‡çš„ issue æŠ¥å‘Š"

      - name: Post analysis summary as comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get Claude's analysis result
            const stepOutputs = ${{ toJson(steps.claude_analysis.outputs) }};
            const analysisResult = stepOutputs.response || stepOutputs.result || stepOutputs.output || '';

            // Get workflow run URL
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}`;

            let commentBody = `## ðŸ¤– Auto Comment Analysis Summary\n\n`;

            if (analysisResult && analysisResult.trim() !== '') {
              commentBody += `**Claude Analysis Result:**\n\`\`\`\n${analysisResult}\n\`\`\`\n\n`;
            } else {
              commentBody += `**Status:** Analysis completed successfully.\n\n`;
            }

            commentBody += `**Workflow Run:** [View Details](${runUrl})\n`;
            commentBody += `**Triggered by:** Issue #${issue_number}\n`;
            commentBody += `**Time:** ${new Date().toISOString()}\n\n`;
            commentBody += `---\n*This comment was automatically generated by the Auto Comment for Clarity workflow.*`;

            // Only post if this is an issue event (not discussion)
            if (context.eventName === 'issues') {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: commentBody
              });
              console.log('Posted analysis summary to issue #' + issue_number);
            } else {
              console.log('Skipped posting comment - not an issue event');
            }
