# Copyright 2024-2026 the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Auto Comment for Clarity
on:
  issues:
    types: [opened]
  discussions:
    types: [created]
jobs:
  auto-comment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      discussions: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze issue and create comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Handle both issues and discussions
            let title, body, number, targetType, targetUrl;
            
            if (context.eventName === 'issues') {
              number = context.issue.number;
              title = context.payload.issue.title || '';
              body = context.payload.issue.body || '';
              targetType = 'issue';
              targetUrl = context.payload.issue.html_url;
            } else if (context.eventName === 'discussions') {
              number = context.payload.discussion.number;
              title = context.payload.discussion.title || '';
              body = context.payload.discussion.body || '';
              targetType = 'discussion';
              targetUrl = context.payload.discussion.html_url;
            } else {
              console.log('Unsupported event type:', context.eventName);
              return;
            }

            console.log('Target Type:', targetType);
            console.log('Target Number:', number);
            console.log('Title:', title);
            console.log('Body:', body);

            // Analyze what's missing specifically
            const hasDetailedDescription = body.length > 50 && !body.includes('No response');
            const hasStepsToReproduce = body.toLowerCase().includes('æ­¥éª¤') || body.toLowerCase().includes('é‡ç°') || body.toLowerCase().includes('reproduce');
            const hasEnvironmentInfo = body.toLowerCase().includes('ç¯å¢ƒ') || body.toLowerCase().includes('ç‰ˆæœ¬') || body.toLowerCase().includes('version');
            const hasExpectedBehavior = body.toLowerCase().includes('æœŸæœ›') || body.toLowerCase().includes('expected');
            const hasErrorDetails = body.toLowerCase().includes('é”™è¯¯') || body.toLowerCase().includes('error') || body.toLowerCase().includes('å¼‚å¸¸');

            // Check if this looks like a bug report that needs more info
            const isBugReport = title.toLowerCase().includes('bug') || title.toLowerCase().includes('é”™è¯¯');
            const hasVeryShortDescription = body.trim().length < 30 || body === 'No response' || body.includes('è¿™ä¸ªæ€ä¹ˆç”¨') || body.includes('ä¸çŸ¥é“ä¸ºä»€ä¹ˆ');

            // Generate dynamic comment based on what's missing
            const missingItems = [];
            const suggestions = [];

            if (hasVeryShortDescription) {
              missingItems.push('è¯¦ç»†çš„é—®é¢˜æè¿°');
              suggestions.push('è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„å…·ä½“é—®é¢˜ï¼Œè€Œä¸æ˜¯ç®€å•çš„ä¸€å¥è¯');
            }

            if (isBugReport && !hasStepsToReproduce) {
              missingItems.push('é‡ç°æ­¥éª¤');
              suggestions.push('è¯·æä¾›èƒ½å¤Ÿé‡ç°é—®é¢˜çš„å…·ä½“æ“ä½œæ­¥éª¤');
            }

            if (isBugReport && !hasErrorDetails) {
              missingItems.push('é”™è¯¯ä¿¡æ¯');
              suggestions.push('è¯·æä¾›å®Œæ•´çš„é”™è¯¯ä¿¡æ¯ã€å¼‚å¸¸å †æ ˆæˆ–é”™è¯¯æ—¥å¿—');
            }

            if (isBugReport && !hasEnvironmentInfo) {
              missingItems.push('ç¯å¢ƒä¿¡æ¯');
              suggestions.push('è¯·æä¾› mem4j ç‰ˆæœ¬ã€Java ç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿç­‰ç¯å¢ƒä¿¡æ¯');
            }

            if (!hasExpectedBehavior && isBugReport) {
              missingItems.push('æœŸæœ›è¡Œä¸º');
              suggestions.push('è¯·æè¿°æ‚¨æœŸæœ›çš„æ­£ç¡®è¡Œä¸ºåº”è¯¥æ˜¯ä»€ä¹ˆ');
            }

            // Only comment if there are missing items
            if (missingItems.length > 0) {
              let commentLines = [
                'ğŸ‘‹ æ„Ÿè°¢æ‚¨æäº¤è¿™ä¸ª ' + (targetType === 'issue' ? 'issue' : 'discussion') + 'ï¼',
                '',
                'ä¸ºäº†æ›´å¥½åœ°å¸®åŠ©æ‚¨è§£å†³é—®é¢˜ï¼Œæˆ‘å‘ç°ä»¥ä¸‹ä¿¡æ¯éœ€è¦è¡¥å……ï¼š',
                ''
              ];

              // Add specific missing items
              missingItems.forEach((item, index) => {
                commentLines.push(`${index + 1}. **${item}** - ${suggestions[index]}`);
              });

              commentLines.push('');
              commentLines.push('è¯·ç¼–è¾‘æ‚¨çš„åŸå§‹' + (targetType === 'issue' ? 'issue' : 'discussion') + 'æ¥æ·»åŠ è¿™äº›ä¿¡æ¯ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬æ›´å¿«åœ°å®šä½å’Œè§£å†³é—®é¢˜ã€‚ğŸ™');
              commentLines.push('');
              commentLines.push('---');
              commentLines.push('*è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æé†’ï¼Œæ—¨åœ¨æé«˜' + (targetType === 'issue' ? 'issue' : 'discussion') + 'çš„è´¨é‡å’Œè§£å†³æ•ˆç‡ã€‚*');

              const commentBody = commentLines.join('\n');

              // Create comment based on target type
              if (targetType === 'issue') {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: number,
                  body: commentBody
                });
              } else if (targetType === 'discussion') {
                // Use the correct GitHub REST API for discussion comments
                await github.request('POST /repos/{owner}/{repo}/discussions/{discussion_number}/comments', {
                  owner,
                  repo,
                  discussion_number: number,
                  body: commentBody
                });
              }
              
              console.log('Posted targeted clarity request comment to ' + targetType + ' #' + number);
              console.log('Missing items:', missingItems.join(', '));
            } else {
              console.log(targetType + ' has sufficient information, no comment needed');
            }
