# Copyright 2024-2026 the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Auto Comment for Clarity
on:
  issues:
    types: [opened]
  discussion:
    types: [created]
env:
  ANTHROPIC_BASE_URL: "https://open.bigmodel.cn/api/anthropic"
jobs:
  auto-comment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      discussions: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze issue and create comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get issue details
            const issueTitle = context.payload.issue.title || '';
            const issueBody = context.payload.issue.body || '';
            const issueLabels = context.payload.issue.labels?.map(label => label.name).join(', ') || '';

            console.log('Issue Title:', issueTitle);
            console.log('Issue Body:', issueBody);
            console.log('Issue Labels:', issueLabels);

            // Simple analysis logic
            const hasDetailedDescription = issueBody.length > 50 && !issueBody.includes('No response');
            const hasStepsToReproduce = issueBody.toLowerCase().includes('æ­¥éª¤') || issueBody.toLowerCase().includes('é‡ç°') || issueBody.toLowerCase().includes('reproduce');
            const hasEnvironmentInfo = issueBody.toLowerCase().includes('ç¯å¢ƒ') || issueBody.toLowerCase().includes('ç‰ˆæœ¬') || issueBody.toLowerCase().includes('version');
            const hasExpectedBehavior = issueBody.toLowerCase().includes('æœŸæœ›') || issueBody.toLowerCase().includes('expected');

            // Check if this looks like a bug report that needs more info
            const isBugReport = issueTitle.toLowerCase().includes('bug') || issueTitle.toLowerCase().includes('é”™è¯¯');
            const needsMoreInfo = isBugReport && (!hasDetailedDescription || !hasStepsToReproduce || !hasEnvironmentInfo);

            // Also check for very short descriptions
            const hasVeryShortDescription = issueBody.trim().length < 20 || issueBody === 'No response' || issueBody.includes('è¿™ä¸ªæ€ä¹ˆç”¨');

            if (needsMoreInfo || hasVeryShortDescription) {
              const commentBody = 'ğŸ‘‹ æ„Ÿè°¢æ‚¨æäº¤è¿™ä¸ª issueï¼\\n\\nä¸ºäº†æ›´å¥½åœ°å¸®åŠ©æ‚¨è§£å†³é—®é¢˜ï¼Œè¯·è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š\\n\\n- [ ] **è¯¦ç»†çš„é—®é¢˜æè¿°**ï¼šè¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„å…·ä½“é—®é¢˜\\n- [ ] **é‡ç°æ­¥éª¤**ï¼šè¯·æä¾›èƒ½å¤Ÿé‡ç°é—®é¢˜çš„å…·ä½“æ­¥éª¤\\n- [ ] **æœŸæœ›çš„è¡Œä¸º**ï¼šè¯·æè¿°æ‚¨æœŸæœ›çš„æ­£ç¡®è¡Œä¸ºåº”è¯¥æ˜¯ä»€ä¹ˆ\\n- [ ] **å®é™…çš„è¡Œä¸º**ï¼šè¯·æè¿°å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ\\n- [ ] **ç¯å¢ƒä¿¡æ¯**ï¼š\\n  - mem4j ç‰ˆæœ¬\\n  - Java ç‰ˆæœ¬\\n  - æ“ä½œç³»ç»Ÿ\\n  - å…¶ä»–ç›¸å…³é…ç½®\\n\\nè¯·ç¼–è¾‘æ‚¨çš„åŸå§‹ issue æ¥æ·»åŠ è¿™äº›ä¿¡æ¯ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬æ›´å¿«åœ°å®šä½å’Œè§£å†³é—®é¢˜ã€‚ğŸ™';

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: commentBody
              });
              console.log('Posted clarity request comment to issue #' + issue_number);
            } else {
              console.log('Issue has sufficient information, no comment needed');
            }
